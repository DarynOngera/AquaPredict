<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaPredict - Water Resource Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl font-bold">üåä AquaPredict</h1>
            <p class="text-blue-100">Geospatial AI for Sustainable Water Management</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Location Input -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üìç Select Location</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Latitude</label>
                    <input type="number" id="latitude" value="-1.2921" step="0.0001" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Longitude</label>
                    <input type="number" id="longitude" value="36.8219" step="0.0001"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Precipitation (mm/yr)</label>
                    <input type="number" id="precip" value="800" 
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <button onclick="analyzeLocation()" 
                    class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                üîç Analyze Location
            </button>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="border-b">
                <nav class="flex">
                    <button onclick="showTab('probability')" id="tab-probability"
                            class="px-6 py-3 font-medium border-b-2 border-blue-600 text-blue-600">
                        Probability Map
                    </button>
                    <button onclick="showTab('forecast')" id="tab-forecast"
                            class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600">
                        Recharge Forecast
                    </button>
                    <button onclick="showTab('extraction')" id="tab-extraction"
                            class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600">
                        Extraction Recommendations
                    </button>
                    <button onclick="showTab('iso')" id="tab-iso"
                            class="px-6 py-3 font-medium text-gray-600 hover:text-blue-600">
                        ISO 14046 Brief
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- 1. Probability Map -->
                <div id="content-probability">
                    <h3 class="text-xl font-bold mb-4">Probabilistic Aquifer Map & Depth Bands</h3>
                    <div id="probability-results" class="space-y-4"></div>
                </div>

                <!-- 2. Recharge Forecast -->
                <div id="content-forecast" class="hidden">
                    <h3 class="text-xl font-bold mb-4">Groundwater Recharge/Depletion Forecast</h3>
                    <canvas id="forecastChart" class="mb-4"></canvas>
                    <div id="forecast-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>

                <!-- 3. Extraction Recommendations -->
                <div id="content-extraction" class="hidden">
                    <h3 class="text-xl font-bold mb-4">Sustainable Extraction Recommendations</h3>
                    <div id="extraction-results" class="space-y-4"></div>
                </div>

                <!-- 4. ISO 14046 Brief -->
                <div id="content-iso" class="hidden">
                    <h3 class="text-xl font-bold mb-4">ISO 14046 Water Stewardship Brief</h3>
                    <div id="iso-results" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://152.70.16.189:8000';
        let forecastChart = null;

        function showTab(tab) {
            // Hide all
            ['probability', 'forecast', 'extraction', 'iso'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('border-blue-600', 'text-blue-600');
                document.getElementById(`tab-${t}`).classList.add('text-gray-600');
            });
            
            // Show selected
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('border-blue-600', 'text-blue-600');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-600');
        }

        async function analyzeLocation() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const precip = parseFloat(document.getElementById('precip').value);

            const request = {
                latitude: lat,
                longitude: lon,
                precip_mean: precip,
                twi: 8.5,
                elevation: 1500
            };

            // Fetch all data
            await Promise.all([
                fetchProbabilityMap(request),
                fetchForecast(request),
                fetchExtraction(request),
                fetchISO(request)
            ]);
        }

        async function fetchProbabilityMap(request) {
            const response = await fetch(`${API_URL}/api/v1/aquifer/probability-map`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(request)
            });
            const data = await response.json();
            
            const html = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-3xl font-bold text-blue-600">${(data.overall_probability * 100).toFixed(1)}%</div>
                    <div class="text-sm text-gray-600">Overall Aquifer Probability</div>
                    <div class="text-xs text-gray-500 mt-1">
                        Confidence: ${(data.confidence_interval[0] * 100).toFixed(1)}% - ${(data.confidence_interval[1] * 100).toFixed(1)}%
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="font-bold mb-2">Depth Band Analysis</h4>
                    ${data.depth_bands.map(band => `
                        <div class="border rounded-lg p-3 mb-2">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium">${band.depth_range}</div>
                                    <div class="text-sm text-gray-600">Quality: ${band.quality} | Yield: ${band.yield_lpm} L/min</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-blue-600">${(band.probability * 100).toFixed(1)}%</div>
                                    <div class="text-xs text-gray-500">Probability</div>
                                </div>
                            </div>
                            <div class="mt-2 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${band.probability * 100}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="font-bold text-green-800">‚úì Recommendation</div>
                    <div class="text-sm text-green-700 mt-1">
                        Drill at ${data.recommended_drilling_depth} depth in ${data.geological_formation} formation
                    </div>
                </div>
            `;
            
            document.getElementById('probability-results').innerHTML = html;
        }

        async function fetchForecast(request) {
            const response = await fetch(`${API_URL}/api/v1/forecast/recharge?months=12`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(request)
            });
            const data = await response.json();
            
            // Chart
            const ctx = document.getElementById('forecastChart').getContext('2d');
            if (forecastChart) forecastChart.destroy();
            
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.forecast.map(f => f.month),
                    datasets: [{
                        label: 'Recharge (mm)',
                        data: data.forecast.map(f => f.recharge_mm),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true
                    }, {
                        label: 'Depletion (mm)',
                        data: data.forecast.map(f => f.depletion_mm),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '12-Month Recharge/Depletion Forecast'
                        }
                    }
                }
            });

            // Summary
            const summary = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${data.summary.total_recharge_mm.toFixed(0)} mm</div>
                    <div class="text-sm text-gray-600">Total Recharge</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${data.summary.total_depletion_mm.toFixed(0)} mm</div>
                    <div class="text-sm text-gray-600">Total Depletion</div>
                </div>
                <div class="bg-${data.summary.status === 'sustainable' ? 'green' : 'yellow'}-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-${data.summary.status === 'sustainable' ? 'green' : 'yellow'}-600">
                        ${data.summary.net_change_mm.toFixed(0)} mm
                    </div>
                    <div class="text-sm text-gray-600">Net Change (${data.summary.status})</div>
                </div>
            `;
            
            document.getElementById('forecast-summary').innerHTML = summary;
        }

        async function fetchExtraction(request) {
            const response = await fetch(`${API_URL}/api/v1/recommendations/extraction`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(request)
            });
            const data = await response.json();
            
            const html = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">Sustainable Yield</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-2xl font-bold text-blue-600">${data.sustainable_yield.safe_extraction_m3_year.toLocaleString()} m¬≥/yr</div>
                            <div class="text-sm text-gray-600">Safe Annual Extraction</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-600">${data.sustainable_yield.safe_extraction_lpm.toFixed(1)} L/min</div>
                            <div class="text-sm text-gray-600">Safe Extraction Rate</div>
                        </div>
                    </div>
                </div>

                <h4 class="font-bold mb-2">Extraction Scenarios</h4>
                ${data.extraction_scenarios.map(scenario => `
                    <div class="border rounded-lg p-4 mb-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold capitalize">${scenario.scenario}</div>
                                <div class="text-sm text-gray-600 mt-1">${scenario.recommended_for}</div>
                                <div class="text-sm mt-2">
                                    <span class="font-medium">Rate:</span> ${scenario.extraction_rate_lpm.toFixed(1)} L/min
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-green-600">${(scenario.sustainability_score * 100).toFixed(0)}%</div>
                                <div class="text-xs text-gray-500">Sustainability</div>
                                <div class="mt-1 px-2 py-1 rounded text-xs ${
                                    scenario.risk_level === 'very_low' ? 'bg-green-100 text-green-800' :
                                    scenario.risk_level === 'low' ? 'bg-blue-100 text-blue-800' :
                                    'bg-yellow-100 text-yellow-800'
                                }">${scenario.risk_level.replace('_', ' ')}</div>
                            </div>
                        </div>
                    </div>
                `).join('')}

                <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Management Recommendations</h4>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        ${data.management_recommendations.map(rec => `<li>‚Ä¢ ${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('extraction-results').innerHTML = html;
        }

        async function fetchISO(request) {
            const response = await fetch(`${API_URL}/api/v1/reports/iso14046-brief`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(request)
            });
            const data = await response.json();
            
            const html = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-green-800">‚úì ISO 14046:2014 Compliant</div>
                            <div class="text-sm text-green-700">Water Footprint Assessment</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-green-600">Valid for 12 months</div>
                            <div class="text-xs text-green-600">AWS Standard Aligned</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="border rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-600">${data.water_footprint_assessment.total_water_footprint_m3.toLocaleString()} m¬≥</div>
                        <div class="text-sm text-gray-600">Total Water Footprint</div>
                    </div>
                    <div class="border rounded-lg p-4">
                        <div class="text-2xl font-bold text-yellow-600">${data.water_footprint_assessment.water_scarcity_index.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">Water Scarcity Index</div>
                    </div>
                    <div class="border rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-600">${(data.stewardship_indicators.water_use_efficiency * 100).toFixed(0)}%</div>
                        <div class="text-sm text-gray-600">Water Use Efficiency</div>
                    </div>
                </div>

                <div class="border rounded-lg p-4 mb-4">
                    <h4 class="font-bold mb-2">Water Footprint Breakdown</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Blue Water (Surface/Groundwater)</span>
                            <span class="font-medium">${data.water_footprint_assessment.blue_water_footprint_m3.toLocaleString()} m¬≥</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Green Water (Rainwater)</span>
                            <span class="font-medium">${data.water_footprint_assessment.green_water_footprint_m3.toLocaleString()} m¬≥</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Grey Water (Pollution)</span>
                            <span class="font-medium">${data.water_footprint_assessment.grey_water_footprint_m3.toLocaleString()} m¬≥</span>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg p-4">
                    <h4 class="font-bold mb-2">Priority Actions</h4>
                    ${data.recommendations.map(rec => `
                        <div class="mb-3 pb-3 border-b last:border-0">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="font-medium">${rec.action}</div>
                                    <div class="text-sm text-gray-600 mt-1">${rec.expected_impact}</div>
                                </div>
                                <div class="ml-4 text-right">
                                    <div class="px-2 py-1 rounded text-xs ${
                                        rec.priority === 'high' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                    }">${rec.priority}</div>
                                    <div class="text-xs text-gray-500 mt-1">${rec.timeline}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('iso-results').innerHTML = html;
        }

        // Auto-load on page load
        window.onload = () => analyzeLocation();
    </script>
</body>
</html>
